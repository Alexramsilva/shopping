# -*- coding: utf-8 -*-
"""Shopping.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1vN62on2IKMFTxGtru9JUn6COnTZ-Bwzg
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np

st.title("Señal Final: 1 Compra, 2 Venta, 0 Nada")

TICKERS = ["BTC-USD", "GAPB.MX", "PLTR", "SPY", "GRUMAB.MX", "FMTY14.MX", "IAU"]

opcion = st.selectbox("Selecciona señal:", ["Todas", "1 Compra", "2 Venta", "0 Nada"])

resultados = []

for ticker in TICKERS:

    df = yf.download(ticker, period="2y", interval="1d")

    if df.empty:
        continue

    # === APLANAR COLUMNAS SI YFINANCE REGRESA MULTI-ÍNDICE ===
    if isinstance(df.columns, pd.MultiIndex):
        df.columns = [c[0] for c in df.columns]

    # Asegurar que Close existe
    if "Close" not in df.columns:
        st.write(f"Ticker {ticker}: No tiene columna Close")
        continue

    # === Medias Móviles ===
    df["MA5"] = df["Close"].rolling(5).mean()
    df["MA10"] = df["Close"].rolling(10).mean()

    df.dropna(inplace=True)

    # === Señales ===
    df["Signal"] = (df["MA5"] > df["MA10"]).astype(int)
    df["Crossover"] = df["Signal"].diff()

    # === Cálculo x seguro ===
    df["x"] = df["Close"].to_numpy() - df["MA10"].to_numpy()

    # === Resorte ===
    k = 0.001
    df["Force"] = -k * df["x"]

    threshold = df["x"].std() * 1.5
    df["Exit"] = (abs(df["x"]) > threshold).astype(int)
    df["Exit_diff"] = df["Exit"].diff()

    # === Último dato ===
    last = df.iloc[-1]

    # === Estrategia final ===
    if last["Crossover"] == 1:
        estrategia = 1  # Compra
    elif last["Exit"] == 1:
        estrategia = 2  # Venta
    else:
        estrategia = 0

    resultados.append({
        "Ticker": ticker,
        "Fecha": last.name,
        "Close": last["Close"],
        "Estrategia": estrategia
    })

df_final = pd.DataFrame(resultados)

# === Filtro ===
if opcion == "1 Compra":
    df_final = df_final[df_final["Estrategia"] == 1]
elif opcion == "2 Venta":
    df_final = df_final[df_final["Estrategia"] == 2]
elif opcion == "0 Nada":
    df_final = df_final[df_final["Estrategia"] == 0]

st.dataframe(df_final)