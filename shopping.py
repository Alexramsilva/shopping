# -*- coding: utf-8 -*-
"""Shopping.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1vN62on2IKMFTxGtru9JUn6COnTZ-Bwzg
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np

st.title("Estrategias: 0, 1 y 2")

# --- Selección del ticker ---
TICKERS = ["BTC-USD", "GAPB.MX", "PLTR", "SPY", "GRUMAB.MX", "FMTY14.MX", "IAU"]
ticker = st.selectbox("Selecciona un activo:", TICKERS)

# --- Selección de estrategia (0, 1, 2) ---
estrategia = st.selectbox(
    "Selecciona la estrategia:",
    options=[0, 1, 2]
)

# --- Descargar datos ---
df = yf.download(ticker, period="2y", interval="1d")
df.dropna(inplace=True)

# === Medias móviles ===
df["MA5"] = df["Close"].rolling(5).mean()
df["MA10"] = df["Close"].rolling(10).mean()

# === Señales por cruce MA5 vs MA10 ===
df["Signal"] = np.where(df["MA5"] > df["MA10"], 1, 0)
df["Crossover"] = df["Signal"].diff()

# === Modelo del resorte (Hooke) ===
df["x"] = df["Close"] - df["MA10"]
k = 0.001
df["Force"] = -k * df["x"]

threshold = df["x"].std() * 1.5
df["Exit"] = np.where(abs(df["x"]) > threshold, 1, 0)
df["Exit_diff"] = df["Exit"].diff()

exit_dates = df[(df["Exit_diff"] == 1) & (df["MA5"] > df["MA10"])].index
entry_dates = df[(df["Exit_diff"] == -1) & (df["MA5"] < df["MA10"])].index

# -----------------------------
#     Estrategias: 0,1,2
# -----------------------------
df["Strategy"] = 0
df.loc[entry_dates, "Strategy"] = 1
df.loc[exit_dates, "Strategy"] = 2

# === Último día ===
ultimo = df.tail(1)

st.subheader("Estrategia del último día:")
st.write(f"Ticker: **{ticker}**")
st.write(f"Estrategia generada: **{int(ultimo['Strategy'].iloc[0])}**")

# === Mostrar si coincide con la estrategia seleccionada ===
if ultimo["Strategy"].iloc[0] == estrategia:
    st.success(f"Coincide con estrategia {estrategia}")
else:
    st.warning(f"No coincide. La estrategia del día es {int(ultimo['Strategy'].iloc[0])}")

# Mostrar datos del último día
st.dataframe(ultimo[["Close", "MA5", "MA10", "Strategy"]])

# Descargar CSV completo
csv = df.to_csv().encode("utf-8")
st.download_button("Descargar CSV", csv, "estrategias.csv", "text/csv")