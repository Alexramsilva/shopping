# -*- coding: utf-8 -*-
"""Shopping.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1vN62on2IKMFTxGtru9JUn6COnTZ-Bwzg
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np

st.title("Señal Final: 1 Compra, 2 Venta, 0 Nada")

TICKERS = ["BTC-USD", "GAPB.MX", "PLTR", "SPY", "GRUMAB.MX", "FMTY14.MX", "IAU"]

# Selector para estrategia
opcion = st.selectbox("Selecciona estrategia:", ["Todas", "1 Compra", "2 Venta", "0 Nada"])

resultados = []

for ticker in TICKERS:

    df = yf.download(ticker, period="2y", interval="1d")

    if df.empty:
        continue

    # === Medias móviles ===
    df["MA5"] = df["Close"].rolling(5).mean()
    df["MA10"] = df["Close"].rolling(10).mean()

    # IMPORTANTE: eliminar NaN
    df.dropna(inplace=True)

    # === Cruces ===
    df["Signal"] = np.where(df["MA5"] > df["MA10"], 1, 0)
    df["Crossover"] = df["Signal"].diff()

    # === Modelo del resorte ===
    df["x"] = df["Close"] - df["MA10"]
    k = 0.001
    df["Force"] = -k * df["x"]

    threshold = df["x"].std() * 1.5
    df["Exit"] = np.where(abs(df["x"]) > threshold, 1, 0)

    df["Exit_diff"] = df["Exit"].diff()

    # Último dato
    last = df.iloc[-1]

    # === Estrategia ===
    if last["Crossover"] == 1:
        final_signal = 1
    elif last["Exit"] == 1:
        final_signal = 2
    else:
        final_signal = 0

    resultados.append({
        "Ticker": ticker,
        "Fecha": last.name,
        "Close": last["Close"],
        "MA5": last["MA5"],
        "MA10": last["MA10"],
        "x": last["x"],
        "Exit": last["Exit"],
        "Crossover": last["Crossover"],
        "Estrategia": final_signal
    })

# DataFrame final
df_final = pd.DataFrame(resultados)

# Aplicar filtro del menú
if opcion == "1 Compra":
    df_final = df_final[df_final["Estrategia"] == 1]
elif opcion == "2 Venta":
    df_final = df_final[df_final["Estrategia"] == 2]
elif opcion == "0 Nada":
    df_final = df_final[df_final["Estrategia"] == 0]

st.dataframe(df_final)